---
#create a Customer Contact
-
    name: create a Customer Contact
    type: item
    method: POST
    path: '/api/customercontacts/'
    header:
        Content-Type: application/json
    content:
        firstname: 'cust_contact_first'
        lastname: 'cust_contact_last'
        email: 'cust_contact@custcontact.invalid'
        reseller_id: 1
    conditions:
        is:
            code: 201
    retain:
        customer_contact_path: header.location
        customer_contact_id: header.location

#get CustomerContact
-
    name: check CustomerContact
    type: item
    method: GET
    path: '/${customer_contact_path}'
    retain:
        customer_contact: body
    conditions:
        is:
            code: 200

#create a Domain
-
    name: create a Domain
    type: item
    method: POST
    path: /api/domains/
    header:
        Content-Type: application/json
    content:
        domain: test${unique_id}.example.org
        reseller_id: 1
    conditions:
        is:
            code: 201
    retain:
        domain_path: header.location
        domain_id: header.location

#get Domain
-
    name: check Domain
    type: item
    method: GET
    path: '/${domain_path}'
    retain:
        domain: body
    conditions:
        is:
            code: 200

#create billingprofile
-
    name: create billingprofile
    type: item
    method: POST
    path: '/api/billingprofiles/'
    header:
        Content-Type: application/json
    content:
        reseller_id: 1
        handle: test_profile_${unique_id}
        name: test profile ${unique_id}
    retain:
        billingprofile_id: header.location
    conditions:
        is:
            code: 201

#get billingprofile
-
    name: get billingprofile
    type: item
    method: GET
    path: '/api/billingprofiles/${billingprofile_id}'
    retain:
        billingprofile: body
    conditions:
        is:
            code: 200

#create Customer
-
    name: include create Customer
    type: include
    file: CreateCustomer.yaml
    perl_code: !!perl/code |
        {
            my ($retained) = @_;

            $retained->{customer_content} = {
                status => 'active',
                contact_id => $retained->{customer_contact_id},
                billing_profile_id => $retained->{billingprofile_id},
                type => 'sipaccount',
                max_subscribers => undef,
                external_id => undef
            };
        }

#create Subscriber
-
    name: include create Subscriber
    type: include
    file: CreateSubscriber.yaml
    perl_code: !!perl/code |
        {
            my ($retained) = @_;

            my $cc = 800;
            my $ac = '1';
            my $sn = $retained->{unique_id};
            $retained->{customer_id} = $retained->{customer}->{id};
            $retained->{subscriber_content} = {
                primary_number => { cc => $cc, ac => $ac, sn => $sn },
                domain_id => $retained->{domain_id},
                username => 'subscriber_' . '1' . '_'.$retained->{unique_id},
                password => 'subscriber_password',
                customer_id => $retained->{customer_id},
            };
        }

#create voucher
-
    name: create voucher
    type: item
    method: POST
    path: '/api/vouchers/'
    header:
        Content-Type: application/json
    content:
        amount: 1000.0
        code: test_voucher_1${unique_id}
        customer_id: ${customer_id}
        reseller_id: 1
        valid_until: '2037-01-01 00:00:00'
    retain:
        voucher_path1: header.location
    conditions:
        is:
            code: 201

#get Voucher
-
    name: get Voucher
    type: item
    method: GET
    path: '${voucher_path1}'
    retain:
        voucher1: body
    conditions:
        is:
            code: 200

#create voucher
-
    name: create voucher
    type: item
    method: POST
    path: '/api/vouchers/'
    header:
        Content-Type: application/json
    content:
        amount: 1000.0
        code: test_voucher_2${unique_id}
        customer_id: ${customer_id}
        reseller_id: 1
        valid_until: '2010-01-01 00:00:00'
    retain:
        voucher_path2: header.location
    conditions:
        is:
            code: 201

#get Voucher
-
    name: get Voucher
    type: item
    method: GET
    path: '${voucher_path2}'
    retain:
        voucher2: body
    perl_code: !!perl/code |
        {
            my ($retained) = @_;
            $retained->{subscriber_id} = $retained->{subscriber}->{id};
        }
    conditions:
        is:
            code: 200

#perform topup cash
-
    name: perform topup cash
    type: item
    method: POST
    path: '/api/topupcash/'
    header:
        Content-Type: application/json
    content:
        amount: 0.5
        package_id: null
        subscriber_id: invalid
        request_token: 1${unique_id}
    conditions:
        is:
            code: 422